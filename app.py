# app.py - Production-optimized Flask application for MedHub

import os
import logging
from datetime import datetime
from io import BytesIO
from flask import Flask, render_template, request, redirect, url_for, flash, session, send_from_directory, abort
from flask_sqlalchemy import SQLAlchemy
from flask_login import LoginManager, UserMixin, login_user, login_required, logout_user, current_user
from flask_wtf.csrf import CSRFProtect
from werkzeug.security import generate_password_hash, check_password_hash
from werkzeug.utils import secure_filename
from werkzeug.exceptions import BadRequest
import io

# Environment-based configuration
from dotenv import load_dotenv
load_dotenv()

app = Flask(__name__)
app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY', 'dev_secret_fallback')  # Use env var in prod
app.config['SQLALCHEMY_DATABASE_URI'] = os.environ.get('DATABASE_URL', 'sqlite:///medhub.db')
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
app.config['UPLOAD_FOLDER'] = os.environ.get('UPLOAD_FOLDER', 'uploads')
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024  # 16MB max upload
app.config['WTF_CSRF_ENABLED'] = True

# Ensure upload folder exists
os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)

# Initialize extensions
db = SQLAlchemy(app)
csrf = CSRFProtect(app)
login_manager = LoginManager(app)
login_manager.login_view = 'login'
login_manager.login_message = 'Please log in to access this page.'

# Logging setup
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Models (unchanged but added indexes for perf)
class User(db.Model, UserMixin):
    id = db.Column(db.Integer, primary_key=True)
        username = db.Column(db.String(150), unique=True, index=True)
            email = db.Column(db.String(150), unique=True, index=True)
                password = db.Column(db.String(150))
                    role = db.Column(db.String(50), index=True)  # 'patient', 'doctor', 'admin'
                        full_name = db.Column(db.String(150))
                            phone = db.Column(db.String(20))
                                address = db.Column(db.String(200))
                                    availability = db.Column(db.Boolean, default=False)  # For doctors
                                        created_at = db.Column(db.DateTime, default=datetime.utcnow, index=True)

                                        class Prescription(db.Model):
                                            id = db.Column(db.Integer, primary_key=True)
                                                patient_id = db.Column(db.Integer, db.ForeignKey('user.id'), index=True)
                                                    doctor_id = db.Column(db.Integer, db.ForeignKey('user.id'), index=True)
                                                        content = db.Column(db.Text)
                                                            date = db.Column(db.DateTime, default=datetime.utcnow, index=True)

                                                            class MedicalReport(db.Model):
                                                                id = db.Column(db.Integer, primary_key=True)
                                                                    patient_id = db.Column(db.Integer, db.ForeignKey('user.id'), index=True)
                                                                        doctor_id = db.Column(db.Integer, db.ForeignKey('user.id'), index=True)
                                                                            filename = db.Column(db.String(200))
                                                                                date = db.Column(db.DateTime, default=datetime.utcnow, index=True)

                                                                                class Appointment(db.Model):
                                                                                    id = db.Column(db.Integer, primary_key=True)
                                                                                        patient_id = db.Column(db.Integer, db.ForeignKey('user.id'), index=True)
                                                                                            doctor_id = db.Column(db.Integer, db.ForeignKey('user.id'), index=True)
                                                                                                date = db.Column(db.DateTime, index=True)
                                                                                                    status = db.Column(db.String(50), default='pending', index=True)  # pending, accepted, completed

                                                                                                    class DoctorApplication(db.Model):
                                                                                                        id = db.Column(db.Integer, primary_key=True)
                                                                                                            full_name = db.Column(db.String(150))
                                                                                                                email = db.Column(db.String(150))
                                                                                                                    phone = db.Column(db.String(20))
                                                                                                                        qualifications = db.Column(db.Text)
                                                                                                                            status = db.Column(db.String(50), default='pending')
                                                                                                                                created_at = db.Column(db.DateTime, default=datetime.utcnow)

                                                                                                                                @login_manager.user_loader
                                                                                                                                def load_user(user_id):
                                                                                                                                    return User.query.get(int(user_id))

                                                                                                                                    # Create database and indexes
                                                                                                                                    with app.app_context():
                                                                                                                                        db.create_all()
                                                                                                                                            # Add indexes if not exist (for prod migration, use Alembic)
                                                                                                                                                try:
                                                                                                                                                        db.Index('ix_appointment_date_status', Appointment.date, Appointment.status)
                                                                                                                                                            except:
                                                                                                                                                                    pass

                                                                                                                                                                    # Error handlers
                                                                                                                                                                    @app.errorhandler(404)
                                                                                                                                                                    def not_found(error):
                                                                                                                                                                        return render_template('404.html'), 404

                                                                                                                                                                        @app.errorhandler(500)
                                                                                                                                                                        def internal_error(error):
                                                                                                                                                                            logger.error(f'Server error: {str(error)}')
                                                                                                                                                                                return render_template('500.html'), 500

                                                                                                                                                                                @app.errorhandler(BadRequest)
                                                                                                                                                                                def handle_bad_request(e):
                                                                                                                                                                                    flash('Invalid request. Please try again.', 'danger')
                                                                                                                                                                                        return redirect(url_for('index'))

                                                                                                                                                                                        # Routes with input validation and logging
                                                                                                                                                                                        @app.route('/')
                                                                                                                                                                                        def index():
                                                                                                                                                                                            return render_template('index.html')

                                                                                                                                                                                            @app.route('/about')
                                                                                                                                                                                            def about():
                                                                                                                                                                                                return render_template('about.html')

                                                                                                                                                                                                @app.route('/services')
                                                                                                                                                                                                def services():
                                                                                                                                                                                                    return render_template('services.html')

                                                                                                                                                                                                    @app.route('/contact', methods=['GET', 'POST'])
                                                                                                                                                                                                    @csrf.exempt  # If needed, but better to include CSRF in form
                                                                                                                                                                                                    def contact():
                                                                                                                                                                                                        if request.method == 'POST':
                                                                                                                                                                                                                name = request.form.get('name', '').strip()
                                                                                                                                                                                                                        email = request.form.get('email', '').strip()
                                                                                                                                                                                                                                message = request.form.get('message', '').strip()
                                                                                                                                                                                                                                        if not all([name, email, message]):
                                                                                                                                                                                                                                                    flash('All fields are required.', 'danger')
                                                                                                                                                                                                                                                                return render_template('contact.html')
                                                                                                                                                                                                                                                                        # In prod, send email via SMTP or service like SendGrid
                                                                                                                                                                                                                                                                                logger.info(f'Contact form: {name} <{email}> - {message[:100]}')
                                                                                                                                                                                                                                                                                        flash('Your message has been sent!', 'success')
                                                                                                                                                                                                                                                                                                return redirect(url_for('index'))
                                                                                                                                                                                                                                                                                                    return render_template('contact.html')

                                                                                                                                                                                                                                                                                                    @app.route('/register', methods=['GET', 'POST'])
                                                                                                                                                                                                                                                                                                    def register():
                                                                                                                                                                                                                                                                                                        if request.method == 'POST':
                                                                                                                                                                                                                                                                                                                username = request.form.get('username', '').strip()
                                                                                                                                                                                                                                                                                                                        email = request.form.get('email', '').strip().lower()
                                                                                                                                                                                                                                                                                                                                password = request.form.get('password', '')
                                                                                                                                                                                                                                                                                                                                        full_name = request.form.get('full_name', '').strip()
                                                                                                                                                                                                                                                                                                                                                phone = request.form.get('phone', '').strip()
                                                                                                                                                                                                                                                                                                                                                        address = request.form.get('address', '').strip()
                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                        if not all([username, email, password, full_name]):
                                                                                                                                                                                                                                                                                                                                                                                    flash('Required fields missing.', 'danger')
                                                                                                                                                                                                                                                                                                                                                                                                return render_template('register.html')
                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                if len(password) < 8:
                                                                                                                                                                                                                                                                                                                                                                                                                            flash('Password must be at least 8 characters.', 'danger')
                                                                                                                                                                                                                                                                                                                                                                                                                                        return render_template('register.html')
                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                        if User.query.filter((User.username == username) | (User.email == email)).first():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    flash('Username or email already exists.', 'danger')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return render_template('register.html')

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        hashed_pw = generate_password_hash(password)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                new_user = User(username=username, email=email, password=hashed_pw, role='patient',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        full_name=full_name, phone=phone, address=address)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                db.session.add(new_user)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        db.session.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                logger.info(f'New user registered: {username}')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        flash('Registration successful! Please log in.', 'success')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return redirect(url_for('login'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return render_template('register.html')

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    @app.route('/login', methods=['GET', 'POST'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def login():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if request.method == 'POST':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                email = request.form.get('email', '').strip().lower()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        password = request.form.get('password', '')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if not email or not password:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            flash('Email and password required.', 'danger')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return render_template('login.html')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        user = User.query.filter_by(email=email).first()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if user and check_password_hash(user.password, password):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            login_user(user)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        logger.info(f'User logged in: {user.username}')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if user.role == 'admin':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return redirect(url_for('admin_dashboard'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                elif user.role == 'doctor':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return redirect(url_for('doctor_dashboard'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return redirect(url_for('patient_dashboard'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    flash('Invalid email or password.', 'danger')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return render_template('login.html')

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        @app.route('/logout')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        @login_required
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def logout():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            logger.info(f'User logged out: {current_user.username}')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                logout_user()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return redirect(url_for('index'))

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    @app.route('/patient/dashboard')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    @login_required
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def patient_dashboard():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if current_user.role != 'patient':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                abort(403)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if not session.get('paid', False):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return render_template('patient_dashboard.html', appointments=[], prescriptions=[], reports=[],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           show_payment=True)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               appointments = Appointment.query.filter_by(patient_id=current_user.id).order_by(Appointment.date.desc()).limit(10).all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   prescriptions = Prescription.query.filter_by(patient_id=current_user.id).order_by(Prescription.date.desc()).limit(10).all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       reports = MedicalReport.query.filter_by(patient_id=current_user.id).order_by(MedicalReport.date.desc()).limit(10).all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           return render_template('patient_dashboard.html', appointments=appointments,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      prescriptions=prescriptions, reports=reports, show_payment=False)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      @app.route('/patient/book_appointment', methods=['GET', 'POST'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      @login_required
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      def book_appointment():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if current_user.role != 'patient':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  abort(403)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if not session.get('paid', False):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              flash('Payment required to book appointments.', 'danger')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      return redirect(url_for('payment'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          doctors = User.query.filter_by(role='doctor', availability=True).limit(20).all()  # Limit for perf
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if request.method == 'POST':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      doctor_id = request.form.get('doctor_id')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              date_str = request.form.get('date')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if not doctor_id or not date_str:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  flash('Invalid input.', 'danger')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return render_template('book_appointment.html', doctors=doctors)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  date = datetime.fromisoformat(date_str.replace('T', ' ') + ':00')  # Handle datetime-local
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          except ValueError:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      flash('Invalid date format.', 'danger')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  return render_template('book_appointment.html', doctors=doctors)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  # Check if doctor available on that date (basic, add calendar in prod)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          existing = Appointment.query.filter_by(doctor_id=doctor_id, date=date).first()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if existing:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              flash('Doctor not available at that time.', 'danger')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return render_template('book_appointment.html', doctors=doctors)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          new_appointment = Appointment(patient_id=current_user.id, doctor_id=doctor_id, date=date)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  db.session.add(new_appointment)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          db.session.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  logger.info(f'Appointment booked: Patient {current_user.id}, Doctor {doctor_id}')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          flash('Appointment booked! Waiting for doctor approval.', 'success')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  return redirect(url_for('patient_dashboard'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      return render_template('book_appointment.html', doctors=doctors)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      # Other patient routes similar optimizations: limits, validation, logging

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      @app.route('/patient/prescriptions')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      @login_required
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      def patient_prescriptions():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if current_user.role != 'patient':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  abort(403)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      prescriptions = Prescription.query.filter_by(patient_id=current_user.id).order_by(Prescription.date.desc()).limit(20).all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return render_template('prescriptions.html', prescriptions=prescriptions)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          @app.route('/patient/reports')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          @login_required
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          def patient_reports():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if current_user.role != 'patient':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      abort(403)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          reports = MedicalReport.query.filter_by(patient_id=current_user.id).order_by(MedicalReport.date.desc()).limit(20).all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return render_template('reports.html', reports=reports)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              @app.route('/patient/download_report/<int:report_id>')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              @login_required
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              def download_report(report_id):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  report = MedicalReport.query.get_or_404(report_id)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if report.patient_id != current_user.id:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              abort(403)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return send_from_directory(app.config['UPLOAD_FOLDER'], report.filename, as_attachment=True)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              except FileNotFoundError:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      flash('Report not found.', 'danger')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return redirect(url_for('patient_reports'))

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              @app.route('/patient/payment', methods=['GET', 'POST'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              @login_required
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              def payment():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if current_user.role != 'patient':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          abort(403)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if request.method == 'POST':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      # In prod, integrate Stripe/PayPal
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              # For now, simulate
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      session['paid'] = True
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              logger.info(f'Payment simulated for {current_user.username}')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      flash('Payment successful! You now have full access.', 'success')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return redirect(url_for('patient_dashboard'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  return render_template('payment.html')

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  # Doctor routes with similar validations...

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  @app.route('/doctor/dashboard')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  @login_required
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  def doctor_dashboard():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if current_user.role != 'doctor':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              abort(403)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  appointments = Appointment.query.filter_by(doctor_id=current_user.id).order_by(Appointment.date.desc()).limit(20).all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      patients = User.query.filter_by(role='patient').limit(50).all()  # Paginate in prod
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return render_template('doctor_dashboard.html', appointments=appointments, patients=patients)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          @app.route('/doctor/update_availability', methods=['POST'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          @login_required
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          def update_availability():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if current_user.role != 'doctor':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      abort(403)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          avail = request.form.get('availability') == 'on'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              current_user.availability = avail
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  db.session.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      logger.info(f'Doctor {current_user.id} availability: {avail}')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          flash('Availability updated!', 'success')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return redirect(url_for('doctor_dashboard'))

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              # ... (similar for other doctor routes)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              # Admin routes...

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              @app.route('/admin/dashboard')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              @login_required
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              def admin_dashboard():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if current_user.role != 'admin':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          abort(403)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              users = User.query.order_by(User.created_at.desc()).limit(100).all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  applications = DoctorApplication.query.order_by(DoctorApplication.created_at.desc()).limit(20).all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      return render_template('admin_dashboard.html', users=users, applications=applications)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      # ... (rest similar)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      @app.route('/apply_doctor', methods=['GET', 'POST'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      def apply_doctor():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if request.method == 'POST':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  full_name = request.form.get('full_name', '').strip()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          email = request.form.get('email', '').strip().lower()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  phone = request.form.get('phone', '').strip()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          qualifications = request.form.get('qualifications', '').strip()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if not all([full_name, email, phone, qualifications]):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              flash('All fields required.', 'danger')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return render_template('apply_doctor.html')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if DoctorApplication.query.filter_by(email=email).first():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              flash('Application already submitted.', 'danger')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return render_template('apply_doctor.html')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  new_app = DoctorApplication(full_name=full_name, email=email, phone=phone, qualifications=qualifications)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          db.session.add(new_app)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  db.session.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          logger.info(f'Doctor application: {full_name}')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  flash('Application submitted! Admin will review.', 'success')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return redirect(url_for('index'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return render_template('apply_doctor.html')

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              @app.route('/profile', methods=['GET', 'POST'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              @login_required
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              def profile():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if request.method == 'POST':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          current_user.full_name = request.form.get('full_name', current_user.full_name).strip()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  current_user.phone = request.form.get('phone', current_user.phone).strip()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          current_user.address = request.form.get('address', current_user.address).strip()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  db.session.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          flash('Profile updated!', 'success')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return render_template('profile.html')

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              # Static file serving for uploads (secure in prod with nginx)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              @app.route('/uploads/<filename>')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              def uploaded_file(filename):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if __name__ == '__main__':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      app.run(debug=False)  # Never debug=True in prod