# app.py - Updated Flask backend for MedHub with NIN Integration

from flask import Flask, render_template, request, redirect, url_for, session, flash
from flask_sqlalchemy import SQLAlchemy
from flask_wtf import FlaskForm
from wtforms import StringField, PasswordField, SelectField, IntegerField, TextAreaField, DateField
from wtforms.validators import DataRequired, Length, Email, Regexp
from werkzeug.security import generate_password_hash, check_password_hash
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address
from datetime import timedelta, datetime
import os
import requests  # For NIN API (mocked here)

app = Flask(__name__)
app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY', 'your_secret_key')
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///medhub.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
app.config['PERMANENT_SESSION_LIFETIME'] = timedelta(minutes=30)
app.config['WTF_CSRF_ENABLED'] = True
db = SQLAlchemy(app)

limiter = Limiter(
    app=app,
        key_func=get_remote_address,
            default_limits=["200 per day", "50 per hour"]
            )

            # Database Models (Updated with NIN and hospital fields)
            class User(db.Model):
                id = db.Column(db.Integer, primary_key=True)
                    username = db.Column(db.String(50), unique=True, nullable=False)
                        password = db.Column(db.String(255), nullable=False)
                            email = db.Column(db.String(120), unique=True, nullable=False)
                                nin = db.Column(db.String(11))  # New: National ID Number
                                    dob = db.Column(db.String(10))  # New: Date of Birth (YYYY-MM-DD)
                                        gender = db.Column(db.String(10))  # New: Gender
                                            phone = db.Column(db.String(20))  # New: Phone Number
                                                address = db.Column(db.Text)  # New: Address
                                                    role = db.Column(db.String(20), nullable=False)
                                                        email_verified = db.Column(db.Boolean, default=False)

                                                        class Patient(db.Model):
                                                            id = db.Column(db.Integer, primary_key=True)
                                                                user_id = db.Column(db.Integer, db.ForeignKey('user.id'))
                                                                    name = db.Column(db.String(100), nullable=False)
                                                                        age = db.Column(db.Integer)
                                                                            medical_history = db.Column(db.Text)
                                                                                nin = db.Column(db.String(11))  # Linked from User
                                                                                    dob = db.Column(db.String(10))
                                                                                        gender = db.Column(db.String(10))
                                                                                            phone = db.Column(db.String(20))
                                                                                                address = db.Column(db.Text)

                                                                                                class Appointment(db.Model):
                                                                                                    id = db.Column(db.Integer, primary_key=True)
                                                                                                        patient_id = db.Column(db.Integer, db.ForeignKey('patient.id'))
                                                                                                            doctor_id = db.Column(db.Integer, db.ForeignKey('user.id'))
                                                                                                                date = db.Column(db.String(10), nullable=False)
                                                                                                                    time = db.Column(db.String(5), nullable=False)

                                                                                                                    class Prescription(db.Model):
                                                                                                                        id = db.Column(db.Integer, primary_key=True)
                                                                                                                            patient_id = db.Column(db.Integer, db.ForeignKey('patient.id'))
                                                                                                                                doctor_id = db.Column(db.Integer, db.ForeignKey('user.id'))
                                                                                                                                    medication = db.Column(db.String(100), nullable=False)
                                                                                                                                        dosage = db.Column(db.String(50), nullable=False)
                                                                                                                                            instructions = db.Column(db.Text)

                                                                                                                                            # Updated WTForms for Registration (with NIN and hospital fields)
                                                                                                                                            class RegisterForm(FlaskForm):
                                                                                                                                                username = StringField('Username', validators=[DataRequired(), Length(min=4, max=50)])
                                                                                                                                                    email = StringField('Email', validators=[DataRequired(), Email()])
                                                                                                                                                        password = PasswordField('Password', validators=[
                                                                                                                                                                DataRequired(),
                                                                                                                                                                        Length(min=8, message="Password must be at least 8 characters"),
                                                                                                                                                                                Regexp(r'^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@$!%*#?&]{8,}$',
                                                                                                                                                                                               message="Password must contain at least one letter and one number")
                                                                                                                                                                                                   ])
                                                                                                                                                                                                       role = SelectField('Role', choices=[('patient', 'Patient'), ('doctor', 'Doctor'), ('admin', 'Admin')], validators=[DataRequired()])
                                                                                                                                                                                                           name = StringField('Full Name', validators=[DataRequired(), Length(max=100)])
                                                                                                                                                                                                               nin = StringField('National ID Number (NIN)', validators=[Regexp(r'^\d{11}$', message="NIN must be exactly 11 digits")])
                                                                                                                                                                                                                   dob = DateField('Date of Birth', format='%Y-%m-%d', validators=[DataRequired()])
                                                                                                                                                                                                                       gender = SelectField('Gender', choices=[('', 'Select'), ('Male', 'Male'), ('Female', 'Female'), ('Other', 'Other')])
                                                                                                                                                                                                                           phone = StringField('Phone Number', validators=[DataRequired(), Length(min=10, max=15)])
                                                                                                                                                                                                                               address = TextAreaField('Address', validators=[DataRequired()])
                                                                                                                                                                                                                                   age = IntegerField('Age (auto-calculated from DOB)', default=None)  # Optional override
                                                                                                                                                                                                                                       medical_history = TextAreaField('Medical History (for patients)')

                                                                                                                                                                                                                                       class LoginForm(FlaskForm):
                                                                                                                                                                                                                                           username = StringField('Username', validators=[DataRequired()])
                                                                                                                                                                                                                                               password = PasswordField('Password', validators=[DataRequired()])

                                                                                                                                                                                                                                               # Create database
                                                                                                                                                                                                                                               with app.app_context():
                                                                                                                                                                                                                                                   db.create_all()

                                                                                                                                                                                                                                                   # Mock NIN Verification Function (Replace with real API for production)
                                                                                                                                                                                                                                                   def verify_nin(nin, firstname, lastname, dob):
                                                                                                                                                                                                                                                       # Mock: Check basic format
                                                                                                                                                                                                                                                           if len(nin) != 11 or not nin.isdigit():
                                                                                                                                                                                                                                                                   return False, "Invalid NIN format"
                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                           # Simulate API call (e.g., to VerifyMe)
                                                                                                                                                                                                                                                                               # Real integration example (uncomment and add API key):
                                                                                                                                                                                                                                                                                   # url = f"https://vapi.verifyme.ng/v1/verifications/identities/nin/{nin}"
                                                                                                                                                                                                                                                                                       # headers = {"Authorization": "Bearer YOUR_API_KEY"}
                                                                                                                                                                                                                                                                                           # data = {"firstname": firstname.split()[0], "lastname": lastname.split()[-1], "dob": dob}
                                                                                                                                                                                                                                                                                               # response = requests.post(url, json=data, headers=headers)
                                                                                                                                                                                                                                                                                                   # if response.status_code == 200:
                                                                                                                                                                                                                                                                                                       #     result = response.json()
                                                                                                                                                                                                                                                                                                           #     return result['status'] == 'success', result.get('data', {})
                                                                                                                                                                                                                                                                                                               # else:
                                                                                                                                                                                                                                                                                                                   #     return False, "Verification failed"
                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                           # Mock success if name starts with 'J' (for dummy testing)
                                                                                                                                                                                                                                                                                                                               if firstname.lower().startswith('j'):
                                                                                                                                                                                                                                                                                                                                       return True, {"firstname": firstname, "lastname": lastname, "dob": dob, "verified": True}
                                                                                                                                                                                                                                                                                                                                           return False, "NIN verification failed - name/DOB mismatch"

                                                                                                                                                                                                                                                                                                                                           # Dummy Data (Updated with NIN/etc.)
                                                                                                                                                                                                                                                                                                                                           def add_dummy_data():
                                                                                                                                                                                                                                                                                                                                               if User.query.count() == 0:
                                                                                                                                                                                                                                                                                                                                                       admin = User(username='admin', password=generate_password_hash('Admin1234!'), email='admin@medhub.com', role='admin', email_verified=True)
                                                                                                                                                                                                                                                                                                                                                               db.session.add(admin)
                                                                                                                                                                                                                                                                                                                                                                       doctor = User(username='doctor1', password=generate_password_hash('Doctor1234!'), email='doctor1@medhub.com', nin='12345678901', dob='1985-01-15', gender='Male', phone='08012345678', address='123 Hospital St', role='doctor', email_verified=True)
                                                                                                                                                                                                                                                                                                                                                                               db.session.add(doctor)
                                                                                                                                                                                                                                                                                                                                                                                       patient_user = User(username='patient1', password=generate_password_hash('Patient1234!'), email='patient1@medhub.com', nin='09876543210', dob='1995-05-20', gender='Male', phone='08087654321', address='456 Patient Ave', role='patient', email_verified=True)
                                                                                                                                                                                                                                                                                                                                                                                               db.session.add(patient_user)
                                                                                                                                                                                                                                                                                                                                                                                                       db.session.commit()
                                                                                                                                                                                                                                                                                                                                                                                                               patient = Patient(user_id=patient_user.id, name='John Doe', age=30, medical_history='No known allergies.', nin='09876543210', dob='1995-05-20', gender='Male', phone='08087654321', address='456 Patient Ave')
                                                                                                                                                                                                                                                                                                                                                                                                                       db.session.add(patient)
                                                                                                                                                                                                                                                                                                                                                                                                                               db.session.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                                       appmt = Appointment(patient_id=patient.id, doctor_id=doctor.id, date='2025-10-01', time='10:00')
                                                                                                                                                                                                                                                                                                                                                                                                                                               db.session.add(appmt)
                                                                                                                                                                                                                                                                                                                                                                                                                                                       pres = Prescription(patient_id=patient.id, doctor_id=doctor.id, medication='Aspirin', dosage='500mg', instructions='Take once daily.')
                                                                                                                                                                                                                                                                                                                                                                                                                                                               db.session.add(pres)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       db.session.commit()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                       with app.app_context():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           add_dummy_data()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                           # Routes (Updated register with NIN verification)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           @app.route('/')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           def landing():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               return render_template('landing.html')

                                                                                                                                                                                                                                                                                                                                                                                                                                                                               @app.route('/register', methods=['GET', 'POST'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               @limiter.limit("10 per hour")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               def register():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   form = RegisterForm()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       if form.validate_on_submit():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               username = form.username.data
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       email = form.email.data
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               password = form.password.data
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       role = form.role.data
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               name = form.name.data
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       nin = form.nin.data
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               dob = form.dob.data.strftime('%Y-%m-%d') if form.dob.data else None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       gender = form.gender.data
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               phone = form.phone.data
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       address = form.address.data
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               age = form.age.data or ((datetime.now().year - datetime.strptime(dob, '%Y-%m-%d').year) if dob else None)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       medical_history = form.medical_history.data

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               # Check duplicates
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       if User.query.filter_by(username=username).first():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   flash('Username already exists')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               return redirect(url_for('register'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       if User.query.filter_by(email=email).first():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   flash('Email already registered')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               return redirect(url_for('register'))

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       # NIN Verification (mandatory for patients)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               if role == 'patient' and nin:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           verified, result = verify_nin(nin, name.split()[0], name.split()[-1] if len(name.split()) > 1 else '', dob)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       if not verified:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       flash(f'NIN verification failed: {result}')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       return redirect(url_for('register'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   # Use verified data (e.g., update name if mismatch, but mock here)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               flash('NIN verified successfully!')

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       new_user = User(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   username=username,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               password=generate_password_hash(password),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           email=email,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       nin=nin,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   dob=dob,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               gender=gender,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           phone=phone,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       address=address,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   role=role,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               email_verified=False
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               db.session.add(new_user)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       db.session.commit()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               if role == 'patient':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           new_patient = Patient(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           user_id=new_user.id,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           name=name,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           age=age,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           medical_history=medical_history,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           nin=nin,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           dob=dob,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           gender=gender,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           phone=phone,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           address=address
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   db.session.add(new_patient)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               db.session.commit()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       flash('Registration successful! Please check your email to verify (mock).')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               return redirect(url_for('login'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   return render_template('register.html', form=form)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   # ... (Rest of the routes unchanged - login, logout, dashboard, admin, etc.)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   @app.route('/login', methods=['GET', 'POST'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   @limiter.limit("20 per hour")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   def login():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       form = LoginForm()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           if form.validate_on_submit():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   username = form.username.data
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           password = form.password.data
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   user = User.query.filter_by(username=username).first()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           if user and check_password_hash(user.password, password):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       if not user.email_verified:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       flash('Please verify your email first (mock).')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       return redirect(url_for('login'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   session['user_id'] = user.id
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               session['role'] = user.role
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           session.permanent = True
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       return redirect(url_for('dashboard'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               flash('Invalid credentials')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   return render_template('login.html', form=form)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   @app.route('/logout')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   def logout():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       session.clear()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           flash('You have been logged out.')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               return redirect(url_for('landing'))

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               @app.route('/dashboard')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               def dashboard():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   if 'user_id' not in session:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           flash('Please log in to access this page.')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   return redirect(url_for('login'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       role = session.get('role')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           if role == 'admin':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   return redirect(url_for('admin_page'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       elif role == 'doctor':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               return redirect(url_for('doctors_appointments'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   elif role == 'patient':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           return redirect(url_for('client_page'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               flash('Invalid role')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   return redirect(url_for('login'))

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   @app.route('/admin', methods=['GET', 'POST'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   def admin_page():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       if 'role' not in session or session['role'] != 'admin':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               flash('Unauthorized access.')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       return redirect(url_for('login'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           if request.method == 'POST':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   username = request.form['username']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           password = generate_password_hash(request.form['password'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   role = request.form['role']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           new_user = User(username=username, password=password, email=f"{username}@medhub.com", role=role, email_verified=True)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   db.session.add(new_user)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           db.session.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   flash('User added')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       users = User.query.all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           return render_template('admin.html', users=users)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           @app.route('/doctors_appointments', methods=['GET', 'POST'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           def doctors_appointments():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               if 'role' not in session or session['role'] != 'doctor':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       flash('Unauthorized access.')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               return redirect(url_for('login'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   doctor_id = session['user_id']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       if request.method == 'POST':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               patient_id = request.form['patient_id']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       date = request.form['date']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               time = request.form['time']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       new_appmt = Appointment(patient_id=patient_id, doctor_id=doctor_id, date=date, time=time)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               db.session.add(new_appmt)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       db.session.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               flash('Appointment added')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   appointments = Appointment.query.filter_by(doctor_id=doctor_id).all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       patients = Patient.query.all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           return render_template('doctors_appointments.html', appointments=appointments, patients=patients)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           @app.route('/visitors')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           def visitors_page():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               if 'role' not in session or session['role'] not in ['doctor', 'admin']:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       flash('Unauthorized access.')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               return redirect(url_for('login'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   patients = Patient.query.all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       return render_template('visitors.html', patients=patients)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       @app.route('/records', methods=['GET', 'POST'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       def records_page():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           if 'role' not in session or session['role'] not in ['doctor', 'admin']:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   flash('Unauthorized access.')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           return redirect(url_for('login'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               if request.method == 'POST':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       user_id = request.form['user_id']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               name = request.form['name']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       age = request.form['age']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               history = request.form['history']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       new_patient = Patient(user_id=user_id, name=name, age=age, medical_history=history)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               db.session.add(new_patient)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       db.session.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               flash('Record added')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   patients = Patient.query.all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       users = User.query.filter_by(role='patient').all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           return render_template('records.html', patients=patients, users=users)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           @app.route('/prescriptions', methods=['GET', 'POST'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           def prescription_page():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               if 'role' not in session or session['role'] != 'doctor':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       flash('Unauthorized access.')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               return redirect(url_for('login'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   doctor_id = session['user_id']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       if request.method == 'POST':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               patient_id = request.form['patient_id']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       medication = request.form['medication']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               dosage = request.form['dosage']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       instructions = request.form['instructions']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               new_pres = Prescription(patient_id=patient_id, doctor_id=doctor_id, medication=medication, dosage=dosage, instructions=instructions)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       db.session.add(new_pres)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               db.session.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       flash('Prescription added')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           prescriptions = Prescription.query.filter_by(doctor_id=doctor_id).all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               patients = Patient.query.all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   return render_template('prescriptions.html', prescriptions=prescriptions, patients=patients)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   @app.route('/client')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   def client_page():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       if 'role' not in session or session['role'] != 'patient':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               flash('Unauthorized access.')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       return redirect(url_for('login'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           user_id = session['user_id']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               patient = Patient.query.filter_by(user_id=user_id).first()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   if not patient:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           flash('Patient record not found.')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   return redirect(url_for('login'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       appointments = Appointment.query.filter_by(patient_id=patient.id).all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           prescriptions = Prescription.query.filter_by(patient_id=patient.id).all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               return render_template('client.html', patient=patient, appointments=appointments, prescriptions=prescriptions)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               if __name__ == '__main__':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   app.run(debug=True)