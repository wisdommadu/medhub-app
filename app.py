# app.py
import os
from flask import Flask, render_template, request, redirect, url_for, session, flash
from flask_sqlalchemy import SQLAlchemy
from werkzeug.security import generate_password_hash, check_password_hash

app = Flask(__name__)
app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY', 'temporary_debug_key_1234567890')  # Temporary for testing
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:////opt/render/medhub/medhub.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
db = SQLAlchemy(app)

print("Initializing Flask app and SQLAlchemy...")

# Database Models
class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
        username = db.Column(db.String(50), unique=True, nullable=False)
            password = db.Column(db.String(255), nullable=False)
                role = db.Column(db.String(20), nullable=False)  # 'admin', 'doctor', 'patient'

                class Patient(db.Model):
                    id = db.Column(db.Integer, primary_key=True)
                        user_id = db.Column(db.Integer, db.ForeignKey('user.id'))
                            name = db.Column(db.String(100), nullable=False)
                                age = db.Column(db.Integer)
                                    medical_history = db.Column(db.Text)

                                    class Appointment(db.Model):
                                        id = db.Column(db.Integer, primary_key=True)
                                            patient_id = db.Column(db.Integer, db.ForeignKey('patient.id'))
                                                doctor_id = db.Column(db.Integer, db.ForeignKey('user.id'))
                                                    date = db.Column(db.String(10), nullable=False)  # YYYY-MM-DD
                                                        time = db.Column(db.String(5), nullable=False)  # HH:MM
                                                            reason = db.Column(db.String(200))
                                                                status = db.Column(db.String(20), default='Pending')

                                                                class Prescription(db.Model):
                                                                    id = db.Column(db.Integer, primary_key=True)
                                                                        patient_id = db.Column(db.Integer, db.ForeignKey('patient.id'))
                                                                            doctor_id = db.Column(db.Integer, db.ForeignKey('user.id'))
                                                                                medication = db.Column(db.String(100), nullable=False)
                                                                                    dosage = db.Column(db.String(50), nullable=False)
                                                                                        instructions = db.Column(db.Text)

                                                                                        # Create database
                                                                                        try:
                                                                                            with app.app_context():
                                                                                                    print("Creating database...")
                                                                                                            db.create_all()
                                                                                                                    print("Database created successfully")
                                                                                                                    except Exception as e:
                                                                                                                        print(f"Database creation failed: {e}")

                                                                                                                        # Dummy Data (disabled to avoid crashes)
                                                                                                                        """
                                                                                                                        def add_dummy_data():
                                                                                                                            try:
                                                                                                                                    if User.query.count() == 0:
                                                                                                                                                print("Adding dummy data...")
                                                                                                                                                            admin = User(username='admin', password=generate_password_hash('adminpass'), role='admin')
                                                                                                                                                                        db.session.add(admin)
                                                                                                                                                                                    doctor = User(username='doctor1', password=generate_password_hash('docpass'), role='doctor')
                                                                                                                                                                                                db.session.add(doctor)
                                                                                                                                                                                                            patient_user = User(username='patient1', password=generate_password_hash('patpass'), role='patient')
                                                                                                                                                                                                                        db.session.add(patient_user)
                                                                                                                                                                                                                                    db.session.commit()
                                                                                                                                                                                                                                                patient = Patient(user_id=patient_user.id, name='John Doe', age=30, medical_history='No known allergies.')
                                                                                                                                                                                                                                                            db.session.add(patient)
                                                                                                                                                                                                                                                                        db.session.commit()
                                                                                                                                                                                                                                                                                    appmt = Appointment(patient_id=patient.id, doctor_id=doctor.id, date='2025-10-01', time='10:00', reason='Routine checkup')
                                                                                                                                                                                                                                                                                                db.session.add(appmt)
                                                                                                                                                                                                                                                                                                            pres = Prescription(patient_id=patient.id, doctor_id=doctor.id, medication='Aspirin', dosage='500mg', instructions='Take once daily.')
                                                                                                                                                                                                                                                                                                                        db.session.add(pres)
                                                                                                                                                                                                                                                                                                                                    db.session.commit()
                                                                                                                                                                                                                                                                                                                                                print("Dummy data added successfully")
                                                                                                                                                                                                                                                                                                                                                    except Exception as e:
                                                                                                                                                                                                                                                                                                                                                            print(f"Error adding dummy data: {e}")

                                                                                                                                                                                                                                                                                                                                                            try:
                                                                                                                                                                                                                                                                                                                                                                with app.app_context():
                                                                                                                                                                                                                                                                                                                                                                        add_dummy_data()
                                                                                                                                                                                                                                                                                                                                                                        except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                            print(f"Failed to initialize dummy data: {e}")
                                                                                                                                                                                                                                                                                                                                                                            """

                                                                                                                                                                                                                                                                                                                                                                            # Routes
                                                                                                                                                                                                                                                                                                                                                                            @app.route('/')
                                                                                                                                                                                                                                                                                                                                                                            def landing():
                                                                                                                                                                                                                                                                                                                                                                                print("Rendering landing page...")
                                                                                                                                                                                                                                                                                                                                                                                    return render_template('landing.html')

                                                                                                                                                                                                                                                                                                                                                                                    @app.route('/login', methods=['GET', 'POST'])
                                                                                                                                                                                                                                                                                                                                                                                    def login():
                                                                                                                                                                                                                                                                                                                                                                                        if request.method == 'POST':
                                                                                                                                                                                                                                                                                                                                                                                                username = request.form['username']
                                                                                                                                                                                                                                                                                                                                                                                                        password = request.form['password']
                                                                                                                                                                                                                                                                                                                                                                                                                user = User.query.filter_by(username=username).first()
                                                                                                                                                                                                                                                                                                                                                                                                                        if user and check_password_hash(user.password, password):
                                                                                                                                                                                                                                                                                                                                                                                                                                    session['user_id'] = user.id
                                                                                                                                                                                                                                                                                                                                                                                                                                                session['role'] = user.role
                                                                                                                                                                                                                                                                                                                                                                                                                                                            return redirect(url_for('dashboard'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    flash('Invalid credentials')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return render_template('login.html')

                                                                                                                                                                                                                                                                                                                                                                                                                                                                        @app.route('/register', methods=['GET', 'POST'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def register():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if request.method == 'POST':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    username = request.form['username']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            password = request.form['password']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    role = request.form['role']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            name = request.form['name']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    age = request.form['age']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            medical_history = request.form['medical_history'] if role == 'patient' else ''
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if User.query.filter_by(username=username).first():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                flash('Username already exists')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return render_template('register.html')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    new_user = User(username=username, password=generate_password_hash(password), role=role)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            db.session.add(new_user)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    db.session.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if role == 'patient':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        new_patient = Patient(user_id=new_user.id, name=name, age=age, medical_history=medical_history)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    db.session.add(new_patient)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                db.session.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        flash('Registration successful! Please log in.')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return redirect(url_for('login'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return render_template('register.html')

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    @app.route('/logout')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def logout():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        session.clear()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return redirect(url_for('landing'))

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            @app.route('/dashboard')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def dashboard():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if 'user_id' not in session:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return redirect(url_for('login'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            role = session['role']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if role == 'admin':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return redirect(url_for('admin_page'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            elif role == 'doctor':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return redirect(url_for('doctors_appointments'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        elif role == 'patient':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return redirect(url_for('client_page'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return 'Invalid role'

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    @app.route('/admin', methods=['GET', 'POST'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def admin_page():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if 'role' not in session or session['role'] != 'admin':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return redirect(url_for('login'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if request.method == 'POST':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            username = request.form['username']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    password = generate_password_hash(request.form['password'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            role = request.form['role']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    name = request.form['name']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            age = request.form['age'] if role == 'patient' else None
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    medical_history = request.form['medical_history'] if role == 'patient' else ''
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if User.query.filter_by(username=username).first():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        flash('Username already exists')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            new_user = User(username=username, password=password, role=role)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        db.session.add(new_user)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    db.session.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if role == 'patient':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                new_patient = Patient(user_id=new_user.id, name=name, age=age, medical_history=medical_history)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                db.session.add(new_patient)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                db.session.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            flash('User added')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                users = User.query.all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return render_template('admin.html', users=users)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    @app.route('/doctors_appointments', methods=['GET', 'POST'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def doctors_appointments():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if 'role' not in session or session['role'] != 'doctor':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return redirect(url_for('login'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    doctor_id = session['user_id']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if request.method == 'POST':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                patient_id = request.form['patient_id']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        date = request.form['date']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                time = request.form['time']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        reason = request.form['reason']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                new_appmt = Appointment(patient_id=patient_id, doctor_id=doctor_id, date=date, time=time, reason=reason)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        db.session.add(new_appmt)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                db.session.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        flash('Appointment added')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            appointments = Appointment.query.filter_by(doctor_id=doctor_id).all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                patients = Patient.query.all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return render_template('doctors_appointments.html', appointments=appointments, patients=patients)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    @app.route('/visitors')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def visitors_page():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if 'role' not in session or session['role'] not in ['doctor', 'admin']:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return redirect(url_for('login'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    patients = Patient.query.all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return render_template('visitors.html', patients=patients)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        @app.route('/records', methods=['GET', 'POST'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def records_page():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if 'role' not in session or session['role'] not in ['doctor', 'admin']:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return redirect(url_for('login'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if request.method == 'POST':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                user_id = request.form['user_id']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        name = request.form['name']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                age = request.form['age']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        medical_history = request.form['history']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                new_patient = Patient(user_id=user_id, name=name, age=age, medical_history=medical_history)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        db.session.add(new_patient)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                db.session.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        flash('Record added')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            patients = Patient.query.all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                users = User.query.filter_by(role='patient').all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return render_template('records.html', patients=patients, users=users)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    @app.route('/prescriptions', methods=['GET', 'POST'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def prescription_page():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if 'role' not in session or session['role'] != 'doctor':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return redirect(url_for('login'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    doctor_id = session['user_id']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if request.method == 'POST':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                patient_id = request.form['patient_id']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        medication = request.form['medication']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                dosage = request.form['dosage']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        instructions = request.form['instructions']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                new_pres = Prescription(patient_id=patient_id, doctor_id=doctor_id, medication=medication, dosage=dosage, instructions=instructions)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        db.session.add(new_pres)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                db.session.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        flash('Prescription added')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            prescriptions = Prescription.query.filter_by(doctor_id=doctor_id).all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                patients = Patient.query.all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return render_template('prescriptions.html', prescriptions=prescriptions, patients=patients)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    @app.route('/client', methods=['GET', 'POST'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def client_page():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if 'role' not in session or session['role'] != 'patient':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return redirect(url_for('login'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    user_id = session['user_id']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        patient = Patient.query.filter_by(user_id=user_id).first()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if request.method == 'POST':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    doctor_id = request.form['doctor_id']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            date = request.form['date']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    time = request.form['time']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            reason = request.form['reason']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    new_appmt = Appointment(patient_id=patient.id, doctor_id=doctor_id, date=date, time=time, reason=reason)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            db.session.add(new_appmt)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    db.session.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            flash('Appointment booked')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                appointments = Appointment.query.filter_by(patient_id=patient.id).all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    prescriptions = Prescription.query.filter_by(patient_id=patient.id).all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        doctors = User.query.filter_by(role='doctor').all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return render_template('client.html', patient=patient, appointments=appointments, prescriptions=prescriptions, doctors=doctors)